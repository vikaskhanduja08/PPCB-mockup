<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PPCB — Punjab GIS: Pollution Hotspots & Industry Zones</title>

    <!-- Bootstrap (layout) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- (Optional) MarkerCluster CSS if you want clustering -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        body {
            background: #f6f8fa;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(14, 37, 63, 0.06);
        }

        #map {
            height: 700px;
            border-radius: 8px;
        }

        .legend {
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(14, 37, 63, 0.06);
            font-size: 13px;
            line-height: 1.4;
        }

        .legend i {
            width: 14px;
            height: 14px;
            display: inline-block;
            margin-right: 8px;
            opacity: 0.9;
        }

        .topbar {
            padding: 18px;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="topbar d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0 text-success">Punjab Pollution Control Board</h4>
                <small class="text-muted">GIS — Pollution Hotspots & Industry Zones (District view)</small>
            </div>
            <div class="text-end small text-muted">
                Demo — sample data. Replace with live API/GeoJSON for production.
            </div>
        </div>

        <div class="card p-3">
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div>
                    <strong>Map: District Hotspots & Industry Zones</strong><br>
                    <small class="text-muted">Click a marker or polygon to see details. Toggle layers on/off.</small>
                </div>
                <div>
                    <button id="btn-refresh" class="btn btn-sm btn-outline-primary">Refresh (sample)</button>
                </div>
            </div>

            <div id="map"></div>

            <div class="mt-3">
                <small class="text-muted">Tip: Use the layer control (top-right) to toggle Hotspots / Industries.
                    Integrate your API by replacing the sample GeoJSON arrays in the script.</small>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- (Optional) MarkerCluster plugin -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        /************************************************************************
         * Punjab GIS — Pollution Hotspots (district-level) + Industry Zones
         * - All 23 districts included with sample AQI values (replace with live)
         * - Industry zones added as polygons (sample)
         * - Base maps: OpenStreetMap & Esri WorldImagery
         * - Layer control, legend, popups
         ************************************************************************/

        // 1) Initialize map centered on Punjab
        const map = L.map('map', { zoomControl: true }).setView([30.9, 75.5], 7);

        // 2) Base layers
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        const baseMaps = { "OpenStreetMap": osm, "Satellite (Esri)": esriSat };

        // 3) AQI color function (simple scale, adapt thresholds as needed)
        function aqiColor(aqi) {
            if (aqi > 300) return '#800026';
            if (aqi > 200) return '#dc3545';
            if (aqi > 150) return '#fd7e14';
            if (aqi > 100) return '#ffc107';
            if (aqi > 50) return '#20c997';
            return '#198754';
        }

        function aqiStatus(aqi) {
            if (aqi > 300) return 'Hazardous';
            if (aqi > 200) return 'Very Poor';
            if (aqi > 150) return 'Poor';
            if (aqi > 100) return 'Moderate';
            if (aqi > 50) return 'Satisfactory';
            return 'Good';
        }

        // 4) Sample district-level data (name, [lat, lon], sample AQI)
        // Coordinates are approximate district centroids
        const districts = [
            { name: "Amritsar", coords: [31.634, 74.872], aqi: 165 },
            { name: "Barnala", coords: [30.377, 75.548], aqi: 120 },
            { name: "Bathinda", coords: [30.210, 74.945], aqi: 145 },
            { name: "Faridkot", coords: [30.678, 74.755], aqi: 95 },
            { name: "Fatehgarh Sahib", coords: [30.643, 76.401], aqi: 110 },
            { name: "Fazilka", coords: [30.403, 74.028], aqi: 155 },
            { name: "Ferozepur", coords: [30.933, 74.618], aqi: 135 },
            { name: "Gurdaspur", coords: [32.041, 75.405], aqi: 90 },
            { name: "Hoshiarpur", coords: [31.532, 75.912], aqi: 100 },
            { name: "Jalandhar", coords: [31.326, 75.576], aqi: 150 },
            { name: "Kapurthala", coords: [31.379, 75.385], aqi: 105 },
            { name: "Ludhiana", coords: [30.900, 75.857], aqi: 180 },
            { name: "Mansa", coords: [29.989, 75.393], aqi: 140 },
            { name: "Moga", coords: [30.816, 75.171], aqi: 125 },
            { name: "Mohali (SAS Nagar)", coords: [30.704, 76.717], aqi: 130 },
            { name: "Muktsar", coords: [30.476, 74.518], aqi: 115 },
            { name: "Pathankot", coords: [32.273, 75.652], aqi: 85 },
            { name: "Patiala", coords: [30.339, 76.386], aqi: 155 },
            { name: "Rupnagar", coords: [30.968, 76.526], aqi: 95 },
            { name: "Sangrur", coords: [30.245, 75.844], aqi: 135 },
            { name: "Shaheed Bhagat Singh Nagar", coords: [31.126, 76.118], aqi: 105 },
            { name: "Tarn Taran", coords: [31.450, 74.928], aqi: 160 }
        ];

        // 5) Create hotspot markers (clustered)
        const markerClusterGroup = L.markerClusterGroup(); // requires MarkerCluster plugin

        const hotspotLayer = L.layerGroup();
        districts.forEach(d => {
            const r = Math.min(30, Math.max(6, Math.round(d.aqi / 8))); // radius scaled by AQI
            const circle = L.circleMarker(d.coords, {
                radius: r,
                fillColor: aqiColor(d.aqi),
                color: '#ffffff',
                weight: 1,
                fillOpacity: 0.95
            });

            const popupHtml = `
      <div style="min-width:160px">
        <strong>${d.name}</strong><br/>
        AQI: <strong style="color:${aqiColor(d.aqi)}">${d.aqi}</strong><br/>
        Status: <strong>${aqiStatus(d.aqi)}</strong><br/>
        <small class="text-muted">Last updated: ${new Date().toLocaleString()}</small>
      </div>
    `;
            circle.bindPopup(popupHtml);

            // Add to both cluster and plain layer (so toggling still works)
            markerClusterGroup.addLayer(circle);
            hotspotLayer.addLayer(circle);
        });

        // Add cluster group to map by default
        markerClusterGroup.addTo(map);

        // 6) Sample industry zones (polygons) — replace coordinates with real polygons/GeoJSON from your GIS
        const industryZones = {
            "type": "FeatureCollection",
            "features": [
                { "type": "Feature", "properties": { "name": "Ludhiana Industrial Area", "units": 32 }, "geometry": { "type": "Polygon", "coordinates": [[[75.78, 30.86], [75.92, 30.86], [75.92, 30.92], [75.78, 30.92], [75.78, 30.86]]] } },
                { "type": "Feature", "properties": { "name": "Amritsar Industrial Area", "units": 20 }, "geometry": { "type": "Polygon", "coordinates": [[[74.85, 31.62], [74.90, 31.62], [74.90, 31.67], [74.85, 31.67], [74.85, 31.62]]] } }
                // Add more polygons for other industrial clusters...
            ]
        };

        const industryLayer = L.geoJSON(industryZones, {
            style: f => ({ color: '#0d6efd', weight: 1.6, fillColor: 'rgba(13,110,253,0.08)', fillOpacity: 0.6 }),
            onEachFeature: (feature, layer) => {
                const p = feature.properties || {};
                layer.bindPopup(`<strong>${p.name || 'Industry Zone'}</strong><br/>Units: ${p.units || 'N/A'}`);
            }
        });

        industryLayer.addTo(map);

        // 7) Overlay control (toggle hotspots cluster, plain hotspots, industry polygons)
        const overlays = {
            "Hotspot (cluster)": markerClusterGroup,
            "Hotspot (markers)": hotspotLayer,
            "Industry Zones": industryLayer
        };
        L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);

        // 8) Legend control (AQI)
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `<strong>Air Quality (AQI)</strong><br/>
      <i style="background:#198754"></i> Good (&le;50)<br/>
      <i style="background:#20c997"></i> Satisfactory (51–100)<br/>
      <i style="background:#ffc107"></i> Moderate (101–150)<br/>
      <i style="background:#fd7e14"></i> Poor (151–200)<br/>
      <i style="background:#dc3545"></i> Very Poor (201–300)<br/>
      <i style="background:#800026"></i> Hazardous (&gt;300)<br/>`;
            return div;
        };
        legend.addTo(map);

        // 9) Fit bounds to visible data
        const group = L.featureGroup([industryLayer, hotspotLayer]);
        if (group.getBounds().isValid()) map.fitBounds(group.getBounds(), { padding: [40, 40] });

        // 10) Refresh button (demo) — in production, use this to call your API and update layers
        document.getElementById('btn-refresh').addEventListener('click', async () => {
            // Demo: change a random district's AQI to simulate update
            const idx = Math.floor(Math.random() * districts.length);
            districts[idx].aqi = Math.min(400, districts[idx].aqi + Math.floor(Math.random() * 40 - 10));
            // Clear existing layers
            markerClusterGroup.clearLayers();
            hotspotLayer.clearLayers();
            // Rebuild markers with new values
            districts.forEach(d => {
                const r = Math.min(30, Math.max(6, Math.round(d.aqi / 8)));
                const circle = L.circleMarker(d.coords, {
                    radius: r,
                    fillColor: aqiColor(d.aqi),
                    color: '#fff', weight: 1, fillOpacity: 0.95
                });
                circle.bindPopup(`<strong>${d.name}</strong><br/>AQI: <strong style="color:${aqiColor(d.aqi)}">${d.aqi}</strong><br/>Status: <strong>${aqiStatus(d.aqi)}</strong>`);
                markerClusterGroup.addLayer(circle);
                hotspotLayer.addLayer(circle);
            });
            // Ensure cluster layer visible
            if (!map.hasLayer(markerClusterGroup)) markerClusterGroup.addTo(map);
            // optional: show a brief message
            console.info('Hotspots refreshed (demo).');
        });

        /************************************************************************
         *  Integration notes:
         *  - Replace the `districts` array with live data (API returning JSON with lat/lon and AQI).
         *  - Replace `industryZones` GeoJSON with your authoritative GeoJSON (polygons).
         *  - To fetch live data, use fetch('/api/aqi-districts').then(res=>res.json())...
         *  - For many points, consider server-side clustering or heatmap plugin (heatmap.js).
         ************************************************************************/

    </script>

    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>